import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';

// Define the time parameters
const DRAW_START = 9;
const DRAW_END = 21;
const SLOT_MIN = 15;
const ADMIN_PASSWORD = "admin123";

// Helper function to pad numbers with a leading zero
const pad2 = n => String(n).padStart(2, '0');

// The main App component
export default function App() {
  const [drawsToday, setDrawsToday] = useState([]);
  const [activeTab, setActiveTab] = useState('live');
  const [isAdmin, setIsAdmin] = useState(false);
  const [password, setPassword] = useState('');
  const [liveDraw, setLiveDraw] = useState({ A: '--', B: '--', C: '--' });
  const [nextDrawTime, setNextDrawTime] = useState('--:--');
  const [countdown, setCountdown] = useState('-- : --');
  const [loading, setLoading] = useState(true);
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);

  // Firestore path for the public lottery data
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const lotteryDocPath = `artifacts/${appId}/public/data/lottery-draws`;

  // Initialize Firebase and set up the auth state listener
  useEffect(() => {
    try {
      // The variable name is now FIREBASE_CONFIG
      const firebaseConfig = JSON.parse(FIREBASE_CONFIG);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const firestore = getFirestore(app);
      setDb(firestore);

      // Listen for authentication state changes
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (user) {
          setUserId(user.uid);
          console.log("User signed in with UID:", user.uid);
        } else {
          try {
            // Sign in with the provided custom token or anonymously if not available
            if (typeof __initial_auth_token !== 'undefined') {
              const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
              setUserId(userCredential.user.uid);
              console.log("Signed in with custom token.");
            } else {
              const userCredential = await signInAnonymously(auth);
              setUserId(userCredential.user.uid);
              console.log("Signed in anonymously.");
            }
          } catch (error) {
            console.error("Firebase Auth Error:", error);
          }
        }
      });
      return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization failed:", error);
    }
  }, []);

  // Fetch or generate data from Firestore
  useEffect(() => {
    if (!db) return; // Wait for the database to be initialized

    const docRef = doc(db, lotteryDocPath);

    // Set up the real-time listener for the lottery data
    const unsubscribe = onSnapshot(docRef, async (docSnap) => {
      let data = docSnap.data();
      const todayDateStr = new Date().toISOString().split('T')[0];

      if (!docSnap.exists() || data.date !== todayDateStr) {
        // No data or old data exists, so generate a new set for today
        console.log("Generating new draws for the day and saving to Firestore.");
        const newDraws = generateDraws();
        const initialData = {
          date: todayDateStr,
          draws: newDraws,
        };
        await setDoc(docRef, initialData);
        setDrawsToday(newDraws);
      } else {
        // Data for today exists, load it
        console.log("Loading draws from Firestore.");
        setDrawsToday(data.draws);
      }
      setLoading(false); // Data is loaded
    }, (error) => {
      console.error("Error fetching Firestore data:", error);
      setLoading(false); // Stop loading on error
    });

    return () => unsubscribe(); // Clean up the listener on unmount
  }, [db, lotteryDocPath]);

  // Generate an array of lottery draw slots for the day
  const generateDraws = () => {
    const newDraws = [];
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    for (let h = DRAW_START; h < DRAW_END; h++) {
      for (let m = 0; m < 60; m += SLOT_MIN) {
        newDraws.push({
          date: dateStr,
          time: pad2(h) + ":" + pad2(m),
          A: String(Math.floor(Math.random() * 100)).padStart(2, '0'),
          B: String(Math.floor(Math.random() * 100)).padStart(2, '0'),
          C: String(Math.floor(Math.random() * 100)).padStart(2, '0'),
        });
      }
    }
    return newDraws;
  };

  // Update live view based on time
  useEffect(() => {
    const interval = setInterval(() => {
      const now = new Date();
      const currMinutes = now.getHours() * 60 + now.getMinutes();

      let nextSlotObj = null;
      for (const slot of drawsToday) {
        const [h, m] = slot.time.split(':').map(Number);
        if (h * 60 + m > currMinutes) {
          nextSlotObj = slot;
          break;
        }
      }

      if (nextSlotObj) {
        const [h, m] = nextSlotObj.time.split(':').map(Number);
        const nextDate = new Date();
        nextDate.setHours(h);
        nextDate.setMinutes(m);
        nextDate.setSeconds(0);
        nextDate.setMilliseconds(0);
        const diff = Math.max(0, (nextDate - now) / 1000);
        const mins = Math.floor(diff / 60);
        const secs = Math.floor(diff % 60);
        setCountdown(`${pad2(mins)} : ${pad2(secs)}`);
        setNextDrawTime(nextSlotObj.time);
      } else {
        setCountdown('-- : --');
        setNextDrawTime('--:--');
      }

      const liveSlot = drawsToday.find(slot => {
        const [h, m] = slot.time.split(':').map(Number);
        const currentSlotMinutes = Math.floor(now.getMinutes() / SLOT_MIN) * SLOT_MIN;
        return now.getHours() === h && currentSlotMinutes === m;
      });
      if (liveSlot) {
        setLiveDraw({ A: liveSlot.A, B: liveSlot.B, C: liveSlot.C });
      } else {
        setLiveDraw({ A: '--', B: '--', C: '--' });
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [drawsToday]);

  // Handle admin login
  const handleLogin = () => {
    if (password === ADMIN_PASSWORD) {
      setIsAdmin(true);
      alert('Login successful!');
    } else {
      alert('Wrong password! Please try again.');
    }
    setPassword('');
  };

  // Handle saving admin changes to Firestore
  const handleSaveAdmin = async () => {
    if (!db) return;
    try {
      const docRef = doc(db, lotteryDocPath);
      await setDoc(docRef, { draws: drawsToday }, { merge: true });
      alert('Saved! Changes are now live for all users.');
    } catch (error) {
      console.error("Error saving to Firestore:", error);
      alert('Failed to save changes.');
    }
  };

  // Handle resetting today's draws in Firestore
  const handleResetToday = async () => {
    if (!db) return;
    try {
      const docRef = doc(db, lotteryDocPath);
      const newDraws = generateDraws();
      await setDoc(docRef, { draws: newDraws }, { merge: true });
      alert('Today\'s draws have been reset.');
    } catch (error) {
      console.error("Error resetting draws:", error);
      alert('Failed to reset draws.');
    }
  };

  // Handle exporting data to CSV
  const handleExportCSV = () => {
    let csv = "date,time,A,B,C\n";
    drawsToday.forEach(d => csv += `${d.date},${d.time},${d.A},${d.B},${d.C}\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'draws.csv';
    a.click();
  };

  const handleLogout = () => {
    setIsAdmin(false);
  };
  
  // Inline styles for the component to keep it self-contained
  const styles = {
    // Colors and variables
    '--bg': '#0e0e0f',
    '--card': '#141415',
    '--muted': '#6e6e72',
    '--gold': '#ffcf33',
    '--gold-2': '#ffbf00',
    '--warn': '#e85d5d',
    '--accent': '#2a2a2f',
    '--tableRow': '#1b1b1f',
    '--stroke': '#29292d',
    '--radius': '18px',
    // ...other styles as needed
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen text-lg text-gray-400">
        Loading...
      </div>
    );
  }

  return (
    <div className="min-h-screen font-['Montserrat'] text-white bg-gray-950" style={styles}>
      <header className="sticky top-0 bg-gradient-to-b from-gray-900 to-gray-900 border-b border-gray-800 p-3 text-center font-bold text-gray-100 tracking-wider">
        Rajshree Punjab Lottery
      </header>
      <div className="max-w-3xl mx-auto p-4">
        <nav className="flex gap-2 mb-4 justify-center">
          <button
            className={`py-2 px-3 rounded-xl border border-gray-700 font-bold cursor-pointer transition-colors ${activeTab === 'live' ? 'bg-yellow-950 text-yellow-400 border-yellow-800' : 'bg-gray-800 text-gray-300'}`}
            onClick={() => setActiveTab('live')}
          >
            Live
          </button>
          <button
            className={`py-2 px-3 rounded-xl border border-gray-700 font-bold cursor-pointer transition-colors ${activeTab === 'admin' ? 'bg-yellow-950 text-yellow-400 border-yellow-800' : 'bg-gray-800 text-gray-300'}`}
            onClick={() => setActiveTab('admin')}
          >
            Admin
          </button>
        </nav>

        {/* Live Section */}
        {activeTab === 'live' && (
          <section className="bg-gray-900 border border-gray-800 rounded-2xl p-4 shadow-xl">
            <h1 className="text-3xl font-extrabold text-yellow-400">Rajshree Punjab Lottery</h1>
            <p className="mt-1 text-sm text-gray-400">15-Minute Draws • Live Results (9 AM – 9 PM)</p>
            <div className="flex items-center justify-between mt-3 text-sm text-gray-300">
              <span>{new Date().toLocaleString()}</span>
              <span>Next: <span className="font-semibold">{nextDrawTime}</span></span>
            </div>
            <div className="text-center font-extrabold text-5xl tracking-widest text-red-500 my-3">
              {countdown}
            </div>
            <div className="grid grid-cols-3 gap-3">
              <div className="relative bg-gray-900 border-2 border-yellow-400 rounded-2xl h-24 flex items-center justify-center shadow-xl">
                <span className="absolute top-2 left-3 text-xs font-extrabold text-yellow-600 tracking-wider">A</span>
                <span className="text-4xl font-extrabold text-yellow-400">{liveDraw.A}</span>
              </div>
              <div className="relative bg-gray-900 border-2 border-yellow-400 rounded-2xl h-24 flex items-center justify-center shadow-xl">
                <span className="absolute top-2 left-3 text-xs font-extrabold text-yellow-600 tracking-wider">B</span>
                <span className="text-4xl font-extrabold text-yellow-400">{liveDraw.B}</span>
              </div>
              <div className="relative bg-gray-900 border-2 border-yellow-400 rounded-2xl h-24 flex items-center justify-center shadow-xl">
                <span className="absolute top-2 left-3 text-xs font-extrabold text-yellow-600 tracking-wider">C</span>
                <span className="text-4xl font-extrabold text-yellow-400">{liveDraw.C}</span>
              </div>
            </div>
            <div className="mt-4 overflow-auto rounded-xl border border-gray-800">
              <table className="min-w-full">
                <thead>
                  <tr className="bg-gray-800 text-gray-200 font-extrabold text-sm border-b border-gray-800">
                    <th className="py-3 px-2 text-center">Time</th>
                    <th className="py-3 px-2 text-center">A</th>
                    <th className="py-3 px-2 text-center">B</th>
                    <th className="py-3 px-2 text-center">C</th>
                  </tr>
                </thead>
                <tbody>
                  {drawsToday.filter(slot => {
                    const now = new Date();
                    const [h, m] = slot.time.split(':').map(Number);
                    return now.getHours() * 60 + now.getMinutes() >= h * 60 + m;
                  }).map((slot, index) => (
                    <tr key={index} className={`border-b border-gray-800 ${
                      Math.floor(new Date().getMinutes() / SLOT_MIN) * SLOT_MIN === parseInt(slot.time.split(':')[1]) &&
                      new Date().getHours() === parseInt(slot.time.split(':')[0]) ? 'bg-yellow-950 outline outline-2 outline-yellow-600' : 'bg-gray-800'
                    }`}>
                      <td className={`py-3 px-2 text-center text-gray-300 font-semibold ${
                        Math.floor(new Date().getMinutes() / SLOT_MIN) * SLOT_MIN === parseInt(slot.time.split(':')[1]) &&
                        new Date().getHours() === parseInt(slot.time.split(':')[0]) ? 'text-yellow-300' : ''
                      }`}>{slot.time}</td>
                      <td className={`py-3 px-2 text-center text-gray-300 font-semibold ${
                        Math.floor(new Date().getMinutes() / SLOT_MIN) * SLOT_MIN === parseInt(slot.time.split(':')[1]) &&
                        new Date().getHours() === parseInt(slot.time.split(':')[0]) ? 'text-yellow-300' : ''
                      }`}>{slot.A}</td>
                      <td className={`py-3 px-2 text-center text-gray-300 font-semibold ${
                        Math.floor(new Date().getMinutes() / SLOT_MIN) * SLOT_MIN === parseInt(slot.time.split(':')[1]) &&
                        new Date().getHours() === parseInt(slot.time.split(':')[0]) ? 'text-yellow-300' : ''
                      }`}>{slot.B}</td>
                      <td className={`py-3 px-2 text-center text-gray-300 font-semibold ${
                        Math.floor(new Date().getMinutes() / SLOT_MIN) * SLOT_MIN === parseInt(slot.time.split(':')[1]) &&
                        new Date().getHours() === parseInt(slot.time.split(':')[0]) ? 'text-yellow-300' : ''
                      }`}>{slot.C}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        )}

        {/* Admin Section */}
        {activeTab === 'admin' && (
          <section className="bg-gray-900 border border-gray-800 rounded-2xl p-4 shadow-xl">
            {!isAdmin ? (
              <div className="flex gap-2 items-center">
                <input
                  type="password"
                  placeholder="Enter password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="flex-grow p-3 rounded-lg bg-gray-800 text-gray-300 border border-gray-700"
                />
                <button
                  onClick={handleLogin}
                  className="py-3 px-5 rounded-xl border border-yellow-800 bg-yellow-950 text-yellow-400 font-bold"
                >
                  Login
                </button>
              </div>
            ) : (
              <div>
                <div className="flex flex-col gap-2 max-h-96 overflow-y-auto pr-2">
                  {drawsToday.map((slot, index) => (
                    <div key={index} className="grid grid-cols-4 gap-2 items-center bg-gray-950 border border-gray-800 rounded-xl p-2">
                      <div className="font-extrabold text-yellow-400 text-center">{slot.time}</div>
                      <input
                        type="text"
                        value={slot.A}
                        maxLength="2"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        onChange={(e) => {
                          const newDraws = [...drawsToday];
                          newDraws[index].A = e.target.value.padStart(2, '0');
                          setDrawsToday(newDraws);
                        }}
                        className="w-full p-2 rounded-lg bg-gray-800 text-gray-300 border border-gray-700 text-center"
                      />
                      <input
                        type="text"
                        value={slot.B}
                        maxLength="2"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        onChange={(e) => {
                          const newDraws = [...drawsToday];
                          newDraws[index].B = e.target.value.padStart(2, '0');
                          setDrawsToday(newDraws);
                        }}
                        className="w-full p-2 rounded-lg bg-gray-800 text-gray-300 border border-gray-700 text-center"
                      />
                      <input
                        type="text"
                        value={slot.C}
                        maxLength="2"
                        inputMode="numeric"
                        pattern="[0-9]*"
                        onChange={(e) => {
                          const newDraws = [...drawsToday];
                          newDraws[index].C = e.target.value.padStart(2, '0');
                          setDrawsToday(newDraws);
                        }}
                        className="w-full p-2 rounded-lg bg-gray-800 text-gray-300 border border-gray-700 text-center"
                      />
                    </div>
                  ))}
                </div>
                <div className="flex gap-2 mt-4 justify-end">
                  <button onClick={handleSaveAdmin} className="py-2 px-4 rounded-xl border border-yellow-800 bg-yellow-950 text-yellow-400 font-bold">
                    Save
                  </button>
                  <button onClick={handleResetToday} className="py-2 px-4 rounded-xl border border-red-800 bg-red-950 text-red-400 font-bold">
                    Reset Today
                  </button>
                  <button onClick={handleExportCSV} className="py-2 px-4 rounded-xl border border-gray-700 bg-gray-800 text-gray-300 font-bold">
                    Export CSV
                  </button>
                  <button onClick={handleLogout} className="py-2 px-4 rounded-xl border border-gray-700 bg-gray-800 text-gray-300 font-bold">
                    Logout
                  </button>
                </div>
              </div>
            )}
          </section>
        )}
      </div>
    </div>
  );
}
      
